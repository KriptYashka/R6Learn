{% extends 'base/base.html' %}
{% load static %}
{% load bootstrap_icons %}
{% block content %}
<div class="container-md">
  <h1 class="display-5 text-uppercase">{{ map.title }}</h1>
  <div class="row">
    <!-- Блок с изображением -->
    <div class="col-4">
      <img src="/media/{{ map.img }}" class="img-fluid rounded" alt="Фон карты '{{ map.title }}'">
      <div class="col pt-2">
        <h4 class="text-secondary">Информация:</h4>
      </div>
    </div>
    <!-- Блок описанием и статистикой -->
    <div class="col-8 mt-3">
      <div class="progress" role="progressbar" aria-label="Win rates" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar" style="width: {{ map.mapstatsmodel.win_atk|default:25 }}%; background-color: #0672c9">ATK {{ map.mapstatsmodel.win_atk|default:25 }}%</div>
        <div class="progress-bar" style="width: {{ map.mapstatsmodel.win_def|default:75 }}%; background-color: #d8620b">DEF {{ map.mapstatsmodel.win_def|default:75 }}%</div>
      </div>
      <div class="col mt-3">
        {% if map.mapstatsmodel.description %}
        <p class="lead">{{ map.mapstatsmodel.description }}</p>
        {% else %}
        <p class="text-muted">Описание карты отсутствует.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <hr>

  <!-- Навигация по этажам -->
  <ul class="nav nav-tabs" id="floorTabs" role="tablist">
    {% for level in levels %}
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if forloop.first %}active{% endif %}" id="{{level.0|lower}}-tab" data-bs-toggle="tab" data-bs-target="#level-{{level.0|lower}}" type="button" role="tab">{{level.1}}</button>
    </li>
    {% endfor %}

  </ul>

  <!-- Контент этажей -->
  <div class="tab-content py-4" id="floorTabsContent">
    {% for level in levels %}
    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
         id="level-{{ level.0 }}"
         role="tabpanel"
         aria-labelledby="{{ level.0 }}-tab">

      {% if level.2.exists %}
      <div class="row">
        <!-- Левая миниатюра -->
        <div class="col-md-2 d-flex align-items-center">
          <div class="position-relative w-100">
            <img src="/media/{{ level.2.0.first_img.img }}" class="img-fluid opacity-25">
            <button class="btn btn-sm btn-outline-primary position-absolute top-50 start-50 translate-middle rounded-circle"
                    onclick="prevImage('{{ level.0 }}')">
              {% bs_icon 'chevron-left' %}
            </button>
          </div>
        </div>

        <!-- Основное изображение -->
        <div class="col-md-8 text-center">
          <img id="{{ level.0 }}-main-img"
               src="/media/{{ level.2.0.first_img.img }}"
               class="img-fluid rounded shadow-lg">
          <h4 class="mt-3">{{ level.2.0.name }}</h4>
          <p>{{ level.2.0.description }}</p>
        </div>

        <!-- Правая миниатюра -->
        <div class="col-md-2 d-flex align-items-center">
          <div class="position-relative w-100">
            <img src="/media/{{ level.2.1.first_img.img }}" class="img-fluid opacity-25">
            <button class="btn btn-sm btn-outline-primary position-absolute top-50 start-50 translate-middle rounded-circle"
                    onclick="nextImage('{{ level.0 }}')">
              {% bs_icon 'chevron-right' %}
            </button>
          </div>
        </div>
      </div>
      {% else %}
      <div class="alert alert-info">
        Позиции отсутствуют
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Кнопка добавления позиции -->
  <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
    <a class="btn btn-primary" href="/map/{{ map.title|lower }}/place/create">
      Добавить позицию
    </a>
  </div>
</div>

<script>
  const currentIndices = {
  {% for level in levels %}
  '{{level.0}}': 0,
  {% endfor %}
};

const places = [
    {% for level in levels %}
    {% for place in level.2 %}
    {% if place.first_img %}
    {
      id: '{{ level.0 }}',
      name: '{{ place.name }}',
      description: '{{ place.description|escapejs }}',
      img: '/media/{{ place.first_img.img }}'
    },
    {% endif %}
    {% endfor %}
    {% endfor %}
  ];

function updateFloorDisplay(levelId) {
  if (places.length === 0) return;

  const currentIndex = currentIndices[levelId];
  const currentPlace = places[currentIndex % places.length];

  document.getElementById(`${levelId}-main-img`).src = currentPlace.img;
  document.querySelector(`#level-${levelId} h4`).textContent = currentPlace.name;
  document.querySelector(`#level-${levelId} p`).textContent = currentPlace.description;
}

function nextImage(levelId) {
  currentIndices[levelId]++;
  updateFloorDisplay(levelId);
}

function prevImage(levelId) {
  currentIndices[levelId]--;
  updateFloorDisplay(levelId);
}
</script>
{% endblock %}